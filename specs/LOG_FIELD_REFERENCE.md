# Xiao ↔ INAV Log Field Reference

Quick mapping of the Xiao logs to their INAV sources, units, and transforms. Useful when correlating GP inputs/outputs with blackbox data.

## MSP → AircraftState (inputs to GP)
- Code: `convertMSPStateToAircraftState()` in `src/msplink.cpp`.
- Source packet: `MSP2_INAV_LOCAL_STATE` (`state.local_state`), NEU frame, cm units, quaternion earth→body.
- Conversions:
  - Position: `neuVectorToNedMeters(pos)` → NED meters; if `test_origin_offset` is set (autoc enabled), aircraft_state stores position minus this origin so the craft starts at (0,0,0) in GP space.
  - Velocity: same helper → NED m/s.
  - Quaternion: `neuQuaternionToNed(q)` (normalize; no axis swap).
  - Speed magnitude: `velocity.norm()`.
- Timestamp: `state.inavSampleTimeMsec = timestamp_us / 1000`.

## Autoc enable / origin
- Log: `GP Control: Switch enabled - test origin NED=[n,e,d] - starting flight test`.
- Origin: current `state.local_state.pos` converted NEU cm → NED m.
- Path: generated by `EmbeddedLongSequentialPath`; segments remain at virtual origin (0). Aircraft state is shifted by `-test_origin_offset` so GP sees the craft starting at (0,0,0) when autoc begins.

## Per-cycle logs (during autoc)
- `GP Input: idx=<path_idx> rabbit=[n,e,d] vec=[craft->rabbit NED] alpha/beta/dtheta/dphi/dhome`
  - Rabbit point: translated path start in NED meters.
  - `vec`: `rabbit - aircraft_state.position` (NED meters).
  - Angles/distances: GP operators (`GETALPHA/GETBETA/GETDTHETA/GETDPHI/GETDHOME`) in radians.
- `GP Output: rc=[roll,pitch,throttle]`
  - RC: MSP channel values after conversion (target/idx implied by prior GP Input).

## GP State (always logged each MSP cycle)
- Log: `GP State: pos_raw=[...] pos=[...] vel=[...] quat=[...] armed=... fs=... servo=... autoc=... rabbit=...`
- `pos_raw`: raw INAV NED meters (no origin adjustment).
- `pos`: aircraft_state position (raw minus test_origin when origin set).
- `vel`: NED m/s.
- Flags: ARM/FAILSAFE bits, servo switch state, autoc/rabbit status.

## RC command mapping (GP outputs)
- Functions: `convertRollToMSPChannel`, `convertPitchToMSPChannel`, `convertThrottleToMSPChannel`.
- Roll: GP +1 → MSP 2000, -1 → 1000 (direct).
- Pitch: GP +1 → MSP 1000, -1 → 2000 (inverted to match CRRCSim).
- Throttle: GP +1 → MSP 2000, -1 → 1000 (direct).
- Cached and sent via `MSP_SET_RAW_RC` at `MSP_SEND_INTERVAL_MSEC`.

## Notes for postflight tooling
- INAV blackbox: use `navPos`/`navVel`/`quaternion` (NEU cm) → convert to NED meters and normalize quats.
- Apply origin from `GP Control: Switch enabled` to get relative INAV position: `pos_rel = pos_ned - origin`.
- Xiao position dots: parse `GP State pos` (or `pos_raw` if absolute needed).
- Timebase: use INAV sample time (`inav_ms`) in the log for alignment with blackbox.
